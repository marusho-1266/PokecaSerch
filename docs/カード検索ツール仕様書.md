# ポケモンカード検索ツール 仕様書

## 1. 概要

### 1.1 目的
ポケモンカードゲーム公式サイトのカードデータベースから、様々な条件でカードを検索し、詳細情報を取得・表示するツールを提供する。

### 1.2 対象ユーザー
- デッキ構築中のプレイヤー
- カードコレクター
- メタゲーム分析を行うプレイヤー
- デッキ分析ツールの開発者

### 1.3 技術スタック
- **バックエンド**: Node.js
- **スクレイピング**: Puppeteer（既存のpokeca-deck-fetcherと同様）
- **API**: RESTful API（Express.js推奨）
- **フロントエンド**: HTML/CSS/JavaScript（またはReact/Vue等）

## 2. 機能要件

### 2.1 検索機能

#### 2.1.1 基本検索
| 検索項目 | 説明 | 入力形式 | 例 |
|---------|------|---------|-----|
| カード名 | カード名（部分一致可） | テキスト | "ピカチュウ" |
| カードID | 5桁のカードID | 数値 | 46326 |
| キーワード | カード名や効果文に含まれるキーワード | テキスト | "ex" |

#### 2.1.2 属性検索
| 検索項目 | 説明 | 選択肢 |
|---------|------|--------|
| カテゴリ | カードの種類 | ポケモン、グッズ、ポケモンのどうぐ、サポート、スタジアム、エネルギー |
| タイプ | ポケモンのタイプ | 草、炎、水、雷、超、闘、悪、鋼、無色 |
| 進化段階 | ポケモンの進化段階 | たね、1進化、2進化 |
| HP | HPの範囲 | 数値範囲（例: 100-200） |
| にげるコスト | にげるコスト | 0-4 |
| レギュレーション | 使用可能なレギュレーション | スタンダード、エクストラ、殿堂、XY、SM、S、SV等 |

#### 2.1.3 ワザ検索
| 検索項目 | 説明 | 入力形式 |
|---------|------|---------|
| ワザ名 | ワザ名（部分一致可） | テキスト |
| ダメージ | ダメージの範囲 | 数値範囲（例: 100-200） |
| 必要エネルギー | 必要なエネルギータイプ | 複数選択可（草、炎、水等） |
| ワザ効果 | 効果文に含まれるキーワード | テキスト |

#### 2.1.4 セット検索
| 検索項目 | 説明 | 入力形式 |
|---------|------|---------|
| セット名 | 拡張パック名 | テキスト（部分一致可） |
| セットコード | セットコード | テキスト（例: "SV7a"） |
| カード番号 | セット内のカード番号 | 数値範囲（例: 1-100） |

#### 2.1.5 弱点・抵抗力検索
| 検索項目 | 説明 | 選択肢 |
|---------|------|--------|
| 弱点タイプ | 弱点のタイプ | 草、炎、水、雷、超、闘、悪、鋼、無色 |
| 抵抗力タイプ | 抵抗力のタイプ | 草、炎、水、雷、超、闘、悪、鋼、無色 |

### 2.2 検索結果表示

#### 2.2.1 一覧表示
- **カード画像**: サムネイル表示
- **カード名**: 正式名称（セット情報含む）
- **カテゴリ**: ポケモン/グッズ等
- **基本情報**: HP、タイプ、進化段階（ポケモンの場合）
- **セット情報**: セット名、カード番号
- **レギュレーション**: 使用可能なレギュレーション

#### 2.2.2 詳細表示
- **基本情報**
  - カード名（正式名称）
  - カードID
  - カテゴリ
  - HP（ポケモンの場合）
  - タイプ（ポケモンの場合）
  - 進化段階（ポケモンの場合）
  - 弱点・抵抗力・にげるコスト（ポケモンの場合）
  
- **ワザ情報**（ポケモンの場合）
  - ワザ名
  - 必要エネルギー
  - ダメージ
  - 効果文
  
- **セット情報**
  - セット名
  - セットコード
  - カード番号
  - レアリティ
  
- **画像**
  - 高解像度カード画像
  
- **リンク**
  - 公式サイトのカード詳細ページへのリンク

#### 2.2.3 ソート機能
- カード名（あいうえお順）
- HP（高い順/低い順）
- ダメージ（高い順/低い順）
- セットコード（新しい順/古い順）
- カードID（新しい順/古い順）

#### 2.2.4 フィルタリング機能
- 検索結果をさらに絞り込む
- 複数条件のAND/OR検索

### 2.3 ページネーション
- 検索結果が多い場合、ページ分割して表示
- 1ページあたりの表示件数: 20件、50件、100件から選択可能

## 3. 技術仕様

### 3.1 公式サイトの検索機能の利用

#### 3.1.1 検索URLの構造
公式サイトのカード検索ページは以下のURL形式を使用：

```
https://www.pokemon-card.com/card-search/
```

検索パラメータはPOSTリクエストまたはGETパラメータで送信される。

#### 3.1.2 検索パラメータの構造
公式サイトの検索フォームから送信されるパラメータを解析し、プログラムから検索を実行する。

**主要なパラメータ例:**
- `card_name`: カード名
- `card_type`: カテゴリ
- `regulation`: レギュレーション
- `set`: セットコード
- `hp_min`, `hp_max`: HP範囲
- `waza_name`: ワザ名

### 3.2 API設計

#### 3.2.1 エンドポイント一覧

##### GET /api/cards/search
カード検索を実行する

**クエリパラメータ:**
```typescript
{
  // 基本検索
  name?: string;              // カード名（部分一致）
  cardId?: string;            // カードID（5桁）
  keyword?: string;           // キーワード
  
  // 属性検索
  category?: 'ポケモン' | 'グッズ' | 'ポケモンのどうぐ' | 'サポート' | 'スタジアム' | 'エネルギー';
  type?: '草' | '炎' | '水' | '雷' | '超' | '闘' | '悪' | '鋼' | '無色';
  evolutionStage?: 'たね' | '1進化' | '2進化';
  hpMin?: number;
  hpMax?: number;
  retreatCost?: number;
  regulation?: string;
  
  // ワザ検索
  wazaName?: string;
  damageMin?: number;
  damageMax?: number;
  energyTypes?: string[];     // エネルギータイプの配列
  
  // セット検索
  setName?: string;
  setCode?: string;
  cardNumberMin?: number;
  cardNumberMax?: number;
  
  // 弱点・抵抗力
  weaknessType?: string;
  resistanceType?: string;
  
  // ページネーション
  page?: number;              // ページ番号（デフォルト: 1）
  limit?: number;            // 1ページあたりの件数（デフォルト: 20）
  
  // ソート
  sortBy?: 'name' | 'hp' | 'damage' | 'setCode' | 'cardId';
  sortOrder?: 'asc' | 'desc';
}
```

**レスポンス:**
```typescript
{
  success: boolean;
  data: {
    cards: Card[];
    pagination: {
      page: number;
      limit: number;
      total: number;
      totalPages: number;
    };
  };
  error?: string;
}
```

##### GET /api/cards/:cardId
カードIDから詳細情報を取得する

**パラメータ:**
- `cardId`: カードID（5桁）

**クエリパラメータ:**
- `regulation`: レギュレーション（オプション）

**レスポンス:**
```typescript
{
  success: boolean;
  data: CardDetail;
  error?: string;
}
```

##### GET /api/cards/:cardId/image
カード画像のURLを取得する

**パラメータ:**
- `cardId`: カードID（5桁）

**レスポンス:**
```typescript
{
  success: boolean;
  data: {
    imageUrl: string;
    thumbnailUrl?: string;
  };
  error?: string;
}
```

### 3.3 データ構造

#### 3.3.1 Card（検索結果用）
```typescript
interface Card {
  cardId: string;              // 5桁のカードID
  name: string;                 // カード名
  fullName: string;             // 正式名称（セット情報含む）
  category: string;             // カテゴリ
  imageUrl: string | null;      // 画像URL
  detailUrl: string;           // 詳細ページURL
  
  // ポケモンの場合のみ
  type?: string;                // タイプ
  hp?: number;                  // HP
  evolutionStage?: string;      // 進化段階
  weakness?: string;            // 弱点
  resistance?: string;          // 抵抗力
  retreatCost?: number;         // にげるコスト
  
  // セット情報
  setName?: string;             // セット名
  setCode?: string;             // セットコード
  cardNumber?: string;          // カード番号（例: "080/064"）
  
  // レギュレーション
  regulations?: string[];       // 使用可能なレギュレーション
}
```

#### 3.3.2 CardDetail（詳細情報用）
```typescript
interface CardDetail extends Card {
  // ワザ情報（ポケモンの場合）
  waza?: Waza[];
  
  // その他の詳細情報
  pokedexNumber?: string;       // ポケモン図鑑番号
  illustrator?: string;         // イラストレーター
  rarity?: string;              // レアリティ
}

interface Waza {
  name: string;                 // ワザ名
  nameClean: string;            // ワザ名（クリーン版）
  energyCost: string[];         // 必要エネルギー（配列）
  damage: number | null;        // ダメージ
  effect: string;               // 効果文
}
```

### 3.4 実装方法

#### 3.4.1 スクレイピングアプローチ
既存の`pokeca-deck-fetcher`と同様に、Puppeteerを使用して公式サイトの検索ページから情報を取得する。

**実装フロー:**
1. 検索条件をパラメータとして受け取る
2. Puppeteerで公式サイトの検索ページにアクセス
3. 検索フォームに入力して検索を実行
4. 検索結果ページからカード情報を抽出
5. 必要に応じて各カードの詳細ページにアクセスして詳細情報を取得
6. 構造化されたデータとして返却

**注意事項:**
- サーバー負荷を考慮し、リクエスト間隔を1秒以上設ける
- タイムアウト処理を適切に実装
- エラーハンドリングを徹底
- User-Agentを適切に設定

#### 3.4.2 キャッシュ戦略
- 同じ検索条件の結果は一定時間キャッシュする（例: 1時間）
- カード詳細情報はカードIDをキーとしてキャッシュ
- キャッシュの有効期限を適切に管理

#### 3.4.3 パフォーマンス最適化
- 検索結果の取得は並列処理を活用（ただしサーバー負荷に注意）
- 画像URLは直接取得し、画像自体はダウンロードしない
- ページネーションを適切に実装して、一度に大量のデータを取得しない

## 4. ユーザーインターフェース

### 4.1 Webインターフェース

#### 4.1.1 検索フォーム
- **基本検索欄**: カード名、キーワード入力
- **詳細検索パネル**: 属性、ワザ、セット等の詳細条件
- **検索ボタン**: 検索実行
- **リセットボタン**: 検索条件をクリア

#### 4.1.2 検索結果画面
- **結果件数表示**: "検索結果: 123件"
- **ソート選択**: ドロップダウンメニュー
- **表示件数選択**: 20/50/100件
- **カード一覧**: グリッド表示またはリスト表示
- **ページネーション**: 前へ/次へボタン、ページ番号

#### 4.1.3 カード詳細モーダル/ページ
- **カード画像**: 大きく表示
- **基本情報**: テーブル形式で表示
- **ワザ情報**: リスト形式で表示
- **セット情報**: 表示
- **公式サイトリンク**: 外部リンクボタン

### 4.2 APIインターフェース
RESTful APIとして提供し、他のアプリケーションからも利用可能にする。

## 5. エラーハンドリング

### 5.1 エラー種別
| エラー種別 | HTTPステータス | 説明 |
|-----------|---------------|------|
| InvalidParameterError | 400 | 無効なパラメータ |
| NotFoundError | 404 | カードが見つからない |
| TimeoutError | 408 | タイムアウト |
| NetworkError | 503 | ネットワークエラー |
| ServerError | 500 | サーバーエラー |

### 5.2 エラーレスポンス形式
```typescript
{
  success: false;
  error: {
    code: string;
    message: string;
    details?: any;
  };
}
```

## 6. セキュリティと運用

### 6.1 サーバー負荷対策
- リクエスト間隔: 1秒以上
- 同時リクエスト数: 3件以下
- レート制限: IPアドレスごとに1分あたり10リクエストまで

### 6.2 キャッシュ戦略
- 検索結果: 1時間キャッシュ
- カード詳細: 24時間キャッシュ
- キャッシュキー: 検索条件のハッシュ値、カードID

### 6.3 ログとモニタリング
- 検索リクエストのログ記録
- エラー発生時の詳細ログ
- パフォーマンスメトリクスの収集

## 7. 将来の拡張機能

### 7.1 高度な検索機能
- 複合条件検索（AND/OR/NOT）
- 正規表現による検索
- 保存した検索条件の再利用

### 7.2 データベース化
- カード情報をローカルデータベースに保存
- 定期的なデータ更新機能
- オフライン検索の実現

### 7.3 統計・分析機能
- 検索結果の統計情報表示
- メタゲーム分析との連携
- カード使用率の可視化

### 7.4 外部API連携
- PokemonTCG.io APIとの連携
- 価格情報の取得（中古市場価格等）

## 8. 実装優先順位

### Phase 1: 基本機能（MVP）
1. カード名検索
2. カードID検索
3. カテゴリ検索
4. 検索結果一覧表示
5. カード詳細表示

### Phase 2: 拡張検索機能
1. タイプ検索
2. HP範囲検索
3. セット検索
4. ワザ検索
5. ソート機能

### Phase 3: 高度な機能
1. 複合条件検索
2. キャッシュ機能
3. 統計機能
4. API最適化

## 9. 参考資料

- [SPECIFICATION.md](./pokeca-deck-fetcher/SPECIFICATION.md) - デッキコード取得の仕様
- [カード詳細ページからの情報取得.md](./カード詳細ページからの情報取得.md) - カード詳細情報取得の技術
- [画像取得の仕組み.md](./画像取得の仕組み.md) - 画像取得の仕組み
- [ポケカデッキコードからの情報取得.md](./ポケカデッキコードからの情報取得.md) - デッキコードの技術分析

## 10. 免責事項

このツールは非公式のツールです。公式サイトの利用規約を遵守してご利用ください。公式サイトの仕様変更により、本ツールが動作しなくなる可能性があります。
