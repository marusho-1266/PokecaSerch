# ポケモンカード検索システム 技術スタック検討

本ドキュメントは、[要件定義書](./要件定義書.md)および関連仕様を踏まえ、適切な技術スタックを検討した結果をまとめたものです。DB・ホスティングともに Cloudflare を前提としつつ、制約や代替案も記載します。

---

## 確定技術スタック

| 層 | 技術 | 状態 |
|----|------|------|
| **バックエンド** | **Hono**（Cloudflare Workers） | 確定 |
| **フロントエンド** | **Astro**（Cloudflare Pages） | 確定 |
| データベース | Cloudflare D1 | 前提 |
| ホスティング | Cloudflare Pages + Workers | 前提 |

---

## 1. 推奨スタック（Cloudflare フルスタック）

### 1.1 全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│                        Cloudflare エコシステム                      │
├─────────────────────────────────────────────────────────────────┤
│  Cloudflare Pages (フロントエンド)                                  │
│  └── Astro                                                       │
├─────────────────────────────────────────────────────────────────┤
│  Cloudflare Workers (API / バックエンド)                           │
│  └── Hono による検索API・詳細取得API                               │
├─────────────────────────────────────────────────────────────────┤
│  Cloudflare D1 (データベース)                                      │
│  └── 既存スキーマ (cards, waza, waza_energy_cost, abilities 等)   │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 技術選定の理由

| 領域 | 技術 | 理由 |
|------|------|------|
| **ホスティング** | Cloudflare Pages + Workers | 検索・参照のみの要件に最適。DB (D1) と同一エコシステムで遅延・運用がシンプル |
| **データベース** | Cloudflare D1 | 要件定義で前提。SQLite互換、既存スキーマ準拠 |
| **バックエンド** | **Hono**（Cloudflare Workers） | 確定。軽量・高速。D1 とのバインディングが標準対応 |
| **フロントエンド** | **Astro**（Cloudflare Pages） | 確定。静的 + 部分 hydration で軽量、検索UI に最適 |
| **ランタイム** | Node.js 18+ | 要件定義・既存 pokeca-deck-fetcher との整合 |

---

## 2. 推奨技術スタック詳細

### 2.1 バックエンド（API）

| 項目 | 推奨 | 備考 |
|------|------|------|
| **実行環境** | Cloudflare Workers | エッジで実行、低レイテンシ |
| **フレームワーク** | **Hono**（確定） | Workers 向けに最適化、軽量、型安全 |
| **言語** | TypeScript | 型安全性、スキーマ検証との相性 |
| **ORM / クエリ** | D1 クライアント（直接 SQL） | D1 は ORM のフルサポートが限定的。複雑な JOIN は生 SQL が現実的 |
| **入力検証** | Zod / Valibot | NF-009 の要件を満たすため |
| **ビルド** | Wrangler | Cloudflare 公式 CLI |

**Express について**: 要件定義では Node.js を想定しているが、Cloudflare Workers は Node.js の全 API をサポートしていない。Express は非対応のため、**Hono** を推奨する（API は Express 風に書ける）。

### 2.2 フロントエンド

| 項目 | 推奨 | 備考 |
|------|------|------|
| **ホスティング** | Cloudflare Pages | Pages + Workers で同一ドメイン運用が容易 |
| **フレームワーク** | **Astro**（確定） | 検索UI は静的 + 軽量が望ましい。部分 hydration で軽量 |
| **UI コンポーネント** | 任意（Tailwind CSS + shadcn/ui 等） | デザイン・保守性に応じて選択 |
| **データフェッチ** | fetch + SWR / TanStack Query | キャッシュ・再検証の利便性 |

### 2.3 データベース

| 項目 | 内容 |
|------|------|
| **DB** | Cloudflare D1 |
| **スキーマ** | [テーブル定義書](./Cloudflare%20D1%20テーブル定義書.md) および `database/schema-d1.sql` 準拠 |
| **クエリ制限** | 1 Worker 呼び出しあたり最大 1,000 回の SQL 実行 |
| **読み取り枠** | 無料: 500万行/日、有料: 250億行/月まで無料 |

検索・参照のみのため、読み取り中心の負荷で D1 の無料枠で十分収まる想定。

---

## 3. Cloudflare の制約と対応

### 3.1 Workers の制約

| 制約 | 内容 | 本システムへの影響 |
|------|------|-------------------|
| **CPU 時間** | 無料: 10ms、有料: 30s | 検索・詳細取得は 1〜2 秒以内想定のため、クエリ設計で対応可能 |
| **メモリ** | 128MB | 検索結果のページネーションで十分 |
| **SQL 呼び出し** | 1 リクエストあたり最大 1,000 回 | 検索 1 回で複数クエリを発行する場合、JOIN やサブクエリで集約する |
| **Node.js API** | 一部非対応（fs, child_process 等） | 検索・参照のみのため影響なし |

### 3.2 デッキコード連携（今後の拡張）における注意

**pokeca-deck-fetcher** は **Puppeteer** を使用する。Cloudflare では **Browser Rendering API** と **@cloudflare/puppeteer** が利用可能だが、以下の点に注意が必要:

| 項目 | 内容 |
|------|------|
| **互換性** | 標準 Puppeteer とは API が異なる。`pokeca-deck-fetcher` の改修が必要 |
| **料金** | Browser Rendering は別課金（従量課金） |
| **制限** | セッション時間・同時実行数に制限あり |

**方針案**:
- **検索・参照**: Cloudflare Workers + D1 で完結（推奨）
- **デッキコード取得**: 拡張時は以下のいずれかを検討
  - **A**: `@cloudflare/puppeteer` 対応版の deck-fetcher を実装し、Workers に統合
  - **B**: デッキ取得専用の別サービス（Vercel / Railway 等）を用意し、Workers から HTTP で呼び出す

---

## 4. アーキテクチャ案

### 4.1 ディレクトリ構成例（Cloudflare フルスタック）

```
pokeca-search/
├── apps/
│   ├── web/              # Cloudflare Pages（フロントエンド）
│   │   ├── src/
│   │   └── astro.config.mjs
│   └── api/              # Cloudflare Workers（API）
│       ├── src/
│       │   ├── index.ts
│       │   ├── routes/
│       │   │   ├── cards.ts      # 検索・詳細
│       │   │   └── health.ts
│       │   └── db/
│       │       └── queries.ts
│       └── wrangler.toml
├── database/
│   └── schema-d1.sql
├── packages/
│   └── pokeca-deck-fetcher/   # 既存（拡張時）
└── package.json
```

### 4.2 API エンドポイント（想定）

| メソッド | パス | 説明 |
|----------|------|------|
| GET | `/api/cards` | 検索（クエリパラメータで絞り込み） |
| GET | `/api/cards/:cardId` | カード詳細取得 |
| GET | `/api/health` | ヘルスチェック |

---

## 5. Cloudflare が難しい場合の代替案

### 5.1 代替案 A: Vercel + PlanetScale / Turso

| 項目 | 内容 |
|------|------|
| **フロント** | Vercel (Next.js / Astro 等) |
| **API** | Vercel Serverless Functions (Node.js) |
| **DB** | PlanetScale (MySQL) または Turso (SQLite) |
| **メリット** | フル Node.js、Puppeteer 利用可能（デッキコード拡張が容易） |
| **デメリット** | D1 スキーマのマイグレーションが必要、DB が別プロバイダ |

D1 は SQLite 互換のため、**Turso** への移行は比較的スムーズ（LibSQL/Turso は SQLite 互換）。

### 5.2 代替案 B: Railway / Render

| 項目 | 内容 |
|------|------|
| **ホスティング** | Railway または Render |
| **構成** | Node.js (Express/Hono) + SQLite / PostgreSQL |
| **メリット** | 従来型の Node.js アプリ、制約が少ない |
| **デメリット** | サーバー常時起動、コストが発生しやすい |

小規模・検索専用であれば、D1 の無料枠の方がコスト面で有利な場合が多い。

### 5.3 代替案 C: ハイブリッド（推奨しないが選択肢）

| 項目 | 内容 |
|------|------|
| **検索・参照** | Cloudflare Workers + D1 |
| **デッキコード取得** | Vercel / Railway 等の別サービス |
| **メリット** | 検索は Cloudflare、デッキは Node.js フル機能 |
| **デメリット** | 構築・運用が複雑になる |

---

## 6. 結論と推奨

### 6.1 推奨: Cloudflare フルスタック

本システムのスコープ（**検索・参照のみ**）において、**Cloudflare Workers + D1 + Pages** の組み合わせを推奨する。

| 観点 | 評価 |
|------|------|
| **要件適合** | 検索・詳細取得の API に十分対応 |
| **パフォーマンス** | エッジ実行で低レイテンシ、NF-001/NF-002 を満たしやすい |
| **コスト** | 無料枠で小〜中規模まで運用可能 |
| **運用** | DB・API・フロントを同一プラットフォームで一元管理 |
| **スキーマ** | 既存 D1 スキーマをそのまま利用可能 |

### 6.2 技術スタックまとめ

| 層 | 技術 |
|----|------|
| フロントエンド | Cloudflare Pages + **Astro**（確定） |
| API | Cloudflare Workers + **Hono** + TypeScript（確定） |
| データベース | Cloudflare D1 |
| ビルド・デプロイ | Wrangler + GitHub Actions（任意） |

### 6.3 今後の拡張（デッキコード連携）

- まずは Cloudflare で検索システムを構築
- デッキコード連携を追加する際は、**@cloudflare/puppeteer** の対応可否を検証し、難しければ **Vercel 等の別サービス** でデッキ取得 API を用意する構成を検討

---

**ドキュメント版**: 1.1  
**作成日**: 2025-02-12  
**更新日**: 2025-02-12（バックエンド Hono、フロントエンド Astro を確定として反映）  
**参照**: 要件定義書、Cloudflare D1 テーブル定義書、pokeca-deck-fetcher README
