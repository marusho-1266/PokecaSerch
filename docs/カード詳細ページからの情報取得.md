# **ポケモンカード公式サイトにおけるカード詳細ページからの情報取得技術分析**

ポケモンカードゲーム（以下、ポケカ）の公式サイト「トレーナーズウェブサイト」では、各カードの詳細情報が公開されている。デッキコードから取得したカードIDを基に、カード詳細ページ（`details.php`）から技（ワザ）の情報、必要なエネルギー、HP、弱点・抵抗力などの戦闘パラメータを自動的に抽出する技術的手法について、実証的な検証結果に基づき詳細に分析する。

## **カード詳細ページの構造とURL形式**

### **URL構造の解析**

カード詳細ページへのアクセスは、以下のURL形式で行われる。

```
https://www.pokemon-card.com/card-search/details.php/card/{cardId}/regu/{regulation}/
```

* **cardId**: 5桁のカードID（例: 48717）
* **regulation**: レギュレーション名（例: XY, SM, S, SV など）

実装例として、デッキコードから取得したカードIDを使用する場合：

```javascript
const detailUrl = `https://www.pokemon-card.com/card-search/details.php/card/${cardId}/regu/${regulation}/`;
```

このURLは、デッキ表示ページ（`result.html`）から取得したカード情報の `detailUrl` フィールドに既に含まれている場合もあるが、レギュレーション情報が不足している場合は、デッキのレギュレーション情報から推測するか、デフォルト値を使用する必要がある。

### **ページの基本構造**

カード詳細ページは、以下の主要なセクションで構成されている。

| セクション | HTML要素 | 取得可能な情報 |
| :---- | :---- | :---- |
| カード名 | `<h1>` | カードの正式名称 |
| 基本情報 | 複数の `<div>` 要素 | HP、タイプ（たね/基本/進化）、ポケモン図鑑番号 |
| ワザセクション | `<h2>ワザ</h2>` 以降 | 技名、効果、必要なエネルギー、ダメージ |
| 弱点・抵抗力・にげる | `<table>` | 弱点倍率、抵抗力、にげるコスト |
| 進化情報 | `<h2>進化</h2>` 以降 | 進化前後のポケモン名とリンク |

## **ワザ（技）情報の抽出技術**

### **HTML構造の詳細分析**

ワザ情報は、`<h2>ワザ</h2>` 見出しの直後に配置されている。各技は以下の構造で表現されている。

```html
<h2>ワザ</h2>
<h4>
  <span class="icon-grass icon"></span>
  とつげき
  <span class="f_right Text-fjalla">30</span>
</h4>
<p>このポケモンにも10ダメージ。</p>
```

この構造から、以下の情報を抽出できる：

1. **技名**: `<h4>` タグ内のテキストから、エネルギーアイコンとダメージ数値を除いた部分
2. **ダメージ**: `<span class="f_right Text-fjalla">` 内の数値
3. **技の効果**: `<h4>` の直後の `<p>` タグ内のテキスト
4. **必要なエネルギー**: `<span class="icon-{タイプ} icon">` 要素のクラス名から抽出

### **エネルギー情報の抽出アルゴリズム**

エネルギーアイコンは、CSSクラス名 `icon-{タイプ}` の形式で表現されている。このクラス名からエネルギータイプを抽出する方法は以下の通りである。

```javascript
const extractEnergyCost = (wazaElement) => {
  const energyCost = [];
  const energyIcons = wazaElement.querySelectorAll('span.icon');
  
  energyIcons.forEach(span => {
    const className = span.className || '';
    const typeMatch = className.match(/icon-([a-z]+)/);
    if (typeMatch) {
      const energyType = typeMatch[1];
      energyCost.push(energyType);
    }
  });
  
  return energyCost;
};
```

### **エネルギータイプのマッピング**

公式サイトで使用されているエネルギータイプのクラス名と、その意味は以下の通りである。

| クラス名 | エネルギータイプ | 日本語名 |
| :---- | :---- | :---- |
| `icon-grass` | 草 | 草タイプ |
| `icon-fire` | 炎 | 炎タイプ |
| `icon-water` | 水 | 水タイプ |
| `icon-lightning` | 雷 | 雷タイプ |
| `icon-psychic` | 超 | 超タイプ |
| `icon-fighting` | 闘 | 闘タイプ |
| `icon-dark` | 悪 | 悪タイプ |
| `icon-metal` | 鋼 | 鋼タイプ |
| `icon-colorless` | 無色 | 無色タイプ |

複数のエネルギーが必要な技の場合、`energyCost` 配列には複数のタイプが順番に格納される。例えば、「草エネルギー2つと無色エネルギー1つ」が必要な技の場合、`["grass", "grass", "colorless"]` という形式で取得できる。

### **技情報抽出の完全な実装例**

Puppeteerを使用した実装例：

```javascript
const extractWazaInfo = async (page) => {
  return await page.evaluate(() => {
    const wazaSection = document.querySelector('h2');
    const result = {
      cardName: document.querySelector('h1')?.textContent?.trim() || '',
      waza: []
    };

    if (wazaSection && wazaSection.textContent.includes('ワザ')) {
      let current = wazaSection.nextElementSibling;
      
      while (current && current.tagName !== 'TABLE' && !current.textContent.includes('進化')) {
        if (current.tagName === 'H4') {
          const wazaElement = current;
          
          // エネルギーコストの抽出
          const energyCost = [];
          const energyIcons = wazaElement.querySelectorAll('span.icon');
          energyIcons.forEach(span => {
            const className = span.className || '';
            const typeMatch = className.match(/icon-([a-z]+)/);
            if (typeMatch) {
              energyCost.push(typeMatch[1]);
            }
          });
          
          // 技名の抽出（エネルギーアイコンとダメージを除く）
          const wazaNameFull = wazaElement.textContent.trim();
          const wazaNameClean = wazaElement.textContent
            .replace(/\d+/g, '')
            .trim();
          
          // ダメージの抽出
          const damageMatch = wazaNameFull.match(/(\d+)$/);
          const damage = damageMatch ? parseInt(damageMatch[1]) : null;
          
          // 技の効果の抽出
          let effect = '';
          let next = current.nextElementSibling;
          if (next && next.tagName === 'P') {
            effect = next.textContent.trim();
          }
          
          result.waza.push({
            name: wazaNameFull,
            nameClean: wazaNameClean,
            energyCost: energyCost,
            damage: damage,
            effect: effect
          });
        }
        current = current.nextElementSibling;
      }
    }
    
    return result;
  });
};
```

## **その他のカード属性情報の取得**

### **HPと進化段階情報**

HPと進化段階（たね/1進化/2進化）情報は、カード詳細ページの基本情報セクションから取得できる。

#### **進化段階の抽出方法**

進化段階は、`<span class="type">`要素内に「たね」「1 進化」「2 進化」という形式で表示されている。以下の方法で正確に抽出できる。

**方法1: CSSセレクターを使用した抽出（推奨）**

```javascript
const extractEvolutionStage = async (page) => {
  return await page.evaluate(() => {
    // <span class="type">要素を検索
    const typeElement = document.querySelector('span.type');
    if (typeElement) {
      const text = typeElement.textContent.trim();
      if (text === 'たね') return 'たね';
      if (text.match(/^1\s*進化$/)) return '1進化';
      if (text.match(/^2\s*進化$/)) return '2進化';
    }
    return null;
  });
};
```

**方法2: テキスト検索による抽出（フォールバック）**

```javascript
const extractBasicInfo = async (page) => {
  return await page.evaluate(() => {
    const hpText = document.body.innerText.match(/HP\s*(\d+)/);
    const hp = hpText ? parseInt(hpText[1]) : null;
    
    // 進化段階の抽出（優先順位: たね > 2進化 > 1進化）
    let evolutionStage = null;
    const bodyText = document.body.innerText;
    
    // 「たね」を検索（「たねポケモン」などの文字列に含まれる可能性があるため、単語境界を考慮）
    if (bodyText.match(/\bたね\b/)) {
      evolutionStage = 'たね';
    } else if (bodyText.match(/2\s*進化/)) {
      evolutionStage = '2進化';
    } else if (bodyText.match(/1\s*進化/)) {
      evolutionStage = '1進化';
    }
    
    return { hp, evolutionStage };
  });
};
```

#### **完全な実装例**

```javascript
const extractBasicInfo = async (page) => {
  return await page.evaluate(() => {
    const hpText = document.body.innerText.match(/HP\s*(\d+)/);
    const hp = hpText ? parseInt(hpText[1]) : null;
    
    // 進化段階の抽出（CSSセレクターを優先）
    let evolutionStage = null;
    const typeElement = document.querySelector('span.type');
    
    if (typeElement) {
      const text = typeElement.textContent.trim();
      if (text === 'たね') {
        evolutionStage = 'たね';
      } else if (text.match(/^1\s*進化$/)) {
        evolutionStage = '1進化';
      } else if (text.match(/^2\s*進化$/)) {
        evolutionStage = '2進化';
      }
    }
    
    // CSSセレクターで取得できない場合のフォールバック
    if (!evolutionStage) {
      const bodyText = document.body.innerText;
      if (bodyText.match(/\bたね\b/)) {
        evolutionStage = 'たね';
      } else if (bodyText.match(/2\s*進化/)) {
        evolutionStage = '2進化';
      } else if (bodyText.match(/1\s*進化/)) {
        evolutionStage = '1進化';
      }
    }
    
    return { hp, evolutionStage };
  });
};
```

**注意事項:**
- 進化段階は「たね」「1進化」「2進化」の3種類が存在する
- 「1 進化」のように数字と「進化」の間にスペースが入る場合があるため、正規表現で柔軟に対応する
- エネルギーカードやトレーナーズカードには進化段階が存在しないため、`null`を返す

### **弱点・抵抗力・にげるコスト**

これらの情報は、テーブル形式で表示されている。

```javascript
const extractWeaknessResistance = async (page) => {
  return await page.evaluate(() => {
    const table = document.querySelector('table');
    const result = {
      weakness: '',
      resistance: '',
      retreat: ''
    };
    
    if (table) {
      const rows = table.querySelectorAll('tr');
      if (rows.length > 1) {
        const cells = rows[1].querySelectorAll('td');
        if (cells.length >= 3) {
          result.weakness = cells[0].textContent.trim();
          result.resistance = cells[1].textContent.trim();
          result.retreat = cells[2].textContent.trim();
        }
      }
    }
    
    return result;
  });
};
```

## **実装における技術的考慮事項**

### **動的コンテンツの読み込み待機**

カード詳細ページは、JavaScriptによって動的にコンテンツが読み込まれる場合がある。Puppeteerを使用する際は、適切な待機処理を実装する必要がある。

```javascript
await page.goto(detailUrl, {
  waitUntil: 'networkidle2',
  timeout: 30000
});

// ワザセクションが表示されるまで待機
await page.waitForSelector('h2', { timeout: 10000 });
```

### **エラーハンドリング**

カード詳細ページが存在しない場合や、レギュレーションが一致しない場合のエラーハンドリングを実装する。

```javascript
try {
  const wazaInfo = await extractWazaInfo(page);
  if (wazaInfo.waza.length === 0) {
    // ワザがないカード（エネルギーカードなど）の場合
    console.log('このカードにはワザがありません');
  }
} catch (error) {
  if (error.message.includes('timeout')) {
    console.error('ページの読み込みがタイムアウトしました');
  } else {
    console.error('情報の取得に失敗しました:', error);
  }
}
```

### **パフォーマンス最適化**

大量のカード情報を取得する場合、以下の最適化を検討する。

1. **並列処理**: 複数のカード詳細ページを並列で取得する（ただし、サーバー負荷に注意）
2. **キャッシュ**: 一度取得したカード情報をローカルデータベースに保存し、再取得を避ける
3. **リクエスト間隔**: 連続リクエストの間に適切な待機時間を設ける（推奨: 1秒以上）

```javascript
// 並列処理の例（制限付き）
const cardIds = [48717, 48718, 48719];
const concurrency = 3; // 同時に3つまで

for (let i = 0; i < cardIds.length; i += concurrency) {
  const batch = cardIds.slice(i, i + concurrency);
  await Promise.all(
    batch.map(cardId => fetchCardDetails(cardId))
  );
  // バッチ間で待機
  await new Promise(resolve => setTimeout(resolve, 1000));
}
```

## **取得データの構造化**

### **JSON形式での出力例**

取得した情報を構造化したJSON形式の例：

```json
{
  "cardId": "48717",
  "cardName": "エリカのナゾノクサ",
  "hp": 60,
  "cardType": "たね",
  "waza": [
    {
      "name": "とつげき30",
      "nameClean": "とつげき",
      "energyCost": ["grass"],
      "damage": 30,
      "effect": "このポケモンにも10ダメージ。"
    }
  ],
  "weakness": "×2",
  "resistance": "--",
  "retreat": "",
  "detailUrl": "https://www.pokemon-card.com/card-search/details.php/card/48717/regu/XY/"
}
```

### **データベーススキーマ設計例**

取得した情報をデータベースに保存する場合のスキーマ設計例：

```sql
CREATE TABLE cards (
  card_id VARCHAR(5) PRIMARY KEY,
  card_name VARCHAR(255) NOT NULL,
  hp INTEGER,
  card_type VARCHAR(10),
  weakness VARCHAR(10),
  resistance VARCHAR(10),
  retreat VARCHAR(10),
  detail_url TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE waza (
  id SERIAL PRIMARY KEY,
  card_id VARCHAR(5) REFERENCES cards(card_id),
  name VARCHAR(255) NOT NULL,
  name_clean VARCHAR(255),
  damage INTEGER,
  effect TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE waza_energy_cost (
  id SERIAL PRIMARY KEY,
  waza_id INTEGER REFERENCES waza(id),
  energy_type VARCHAR(20) NOT NULL,
  order_index INTEGER NOT NULL
);
```

## **APIエンドポイントの実装例**

カード詳細情報を取得するAPIエンドポイントの実装例：

```javascript
// カード詳細情報を取得するAPI
app.get('/api/card/:cardId', async (req, res) => {
  const { cardId } = req.params;
  const { regulation = 'XY' } = req.query;

  if (!cardId || !/^\d{5}$/.test(cardId)) {
    return res.status(400).json({ error: '無効なカードIDです' });
  }

  let page = null;
  try {
    const browserInstance = await getBrowser();
    page = await browserInstance.newPage();

    await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');

    const detailUrl = `https://www.pokemon-card.com/card-search/details.php/card/${cardId}/regu/${regulation}/`;
    
    await page.goto(detailUrl, {
      waitUntil: 'networkidle2',
      timeout: 30000
    });

    await page.waitForSelector('h2', { timeout: 10000 });

    // 各種情報を抽出
    const [wazaInfo, basicInfo, weaknessResistance] = await Promise.all([
      extractWazaInfo(page),
      extractBasicInfo(page),
      extractWeaknessResistance(page)
    ]);

    await page.close();

    const cardData = {
      cardId: cardId,
      cardName: wazaInfo.cardName,
      hp: basicInfo.hp,
      cardType: basicInfo.cardType,
      waza: wazaInfo.waza,
      weakness: weaknessResistance.weakness,
      resistance: weaknessResistance.resistance,
      retreat: weaknessResistance.retreat,
      detailUrl: detailUrl
    };

    res.json({
      success: true,
      data: cardData
    });

  } catch (error) {
    console.error('エラーが発生しました:', error);
    
    if (page) {
      await page.close().catch(() => {});
    }

    if (error.message.includes('timeout')) {
      return res.status(408).json({ 
        error: 'タイムアウト: ページの読み込みに時間がかかりすぎました' 
      });
    } else if (error.message.includes('net::ERR')) {
      return res.status(503).json({ 
        error: 'サーバーに接続できませんでした' 
      });
    } else {
      return res.status(500).json({ 
        error: 'カード情報の取得に失敗しました: ' + error.message 
      });
    }
  }
});
```

## **デッキ分析への応用**

### **デッキコードから取得した各ポケモンの進化段階を取得する**

デッキコードから取得したカードリストに対して、各ポケモンカードの進化段階（たね/1進化/2進化）をカード詳細ページから取得する実装例：

```javascript
const getPokemonEvolutionStages = async (deckCode) => {
  // 1. デッキコードからカードリストを取得
  const deckInfo = await getDeckInfo(deckCode);
  
  // 2. ポケモンカードのみを抽出
  const pokemonCards = deckInfo.cards.filter(card => card.category === 'ポケモン');
  
  // 3. 各ポケモンの進化段階を取得（並列処理、ただしサーバー負荷に注意）
  const pokemonWithEvolutionStage = await Promise.all(
    pokemonCards.map(async (card) => {
      try {
        const browserInstance = await getBrowser();
        const page = await browserInstance.newPage();
        
        await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36');
        
        // カード詳細ページのURLを構築（レギュレーションは省略可能）
        const detailUrl = `https://www.pokemon-card.com/card-search/details.php/card/${card.cardId}/`;
        
        await page.goto(detailUrl, {
          waitUntil: 'networkidle2',
          timeout: 30000
        });
        
        // 進化段階を抽出
        const evolutionStage = await page.evaluate(() => {
          const typeElement = document.querySelector('span.type');
          if (typeElement) {
            const text = typeElement.textContent.trim();
            if (text === 'たね') return 'たね';
            if (text.match(/^1\s*進化$/)) return '1進化';
            if (text.match(/^2\s*進化$/)) return '2進化';
          }
          return null;
        });
        
        await page.close();
        
        return {
          ...card,
          evolutionStage: evolutionStage
        };
      } catch (error) {
        console.error(`カード ${card.cardId} (${card.name}) の進化段階取得に失敗:`, error);
        return {
          ...card,
          evolutionStage: null // 取得失敗時はnull
        };
      }
    })
  );
  
  return pokemonWithEvolutionStage;
};
```

**パフォーマンス最適化の実装例:**

大量のカードを処理する場合、以下の最適化を推奨する：

```javascript
const getPokemonEvolutionStagesOptimized = async (deckCode) => {
  const deckInfo = await getDeckInfo(deckCode);
  const pokemonCards = deckInfo.cards.filter(card => card.category === 'ポケモン');
  
  const browserInstance = await getBrowser();
  const results = [];
  
  // バッチ処理（同時に3件まで）
  const batchSize = 3;
  for (let i = 0; i < pokemonCards.length; i += batchSize) {
    const batch = pokemonCards.slice(i, i + batchSize);
    
    const batchResults = await Promise.all(
      batch.map(async (card) => {
        const page = await browserInstance.newPage();
        try {
          await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36');
          const detailUrl = `https://www.pokemon-card.com/card-search/details.php/card/${card.cardId}/`;
          
          await page.goto(detailUrl, {
            waitUntil: 'networkidle2',
            timeout: 30000
          });
          
          const evolutionStage = await page.evaluate(() => {
            const typeElement = document.querySelector('span.type');
            if (typeElement) {
              const text = typeElement.textContent.trim();
              if (text === 'たね') return 'たね';
              if (text.match(/^1\s*進化$/)) return '1進化';
              if (text.match(/^2\s*進化$/)) return '2進化';
            }
            return null;
          });
          
          return { ...card, evolutionStage };
        } catch (error) {
          console.error(`カード ${card.cardId} の取得に失敗:`, error);
          return { ...card, evolutionStage: null };
        } finally {
          await page.close();
        }
      })
    );
    
    results.push(...batchResults);
    
    // バッチ間で待機（サーバー負荷軽減）
    if (i + batchSize < pokemonCards.length) {
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }
  
  return results;
};
```

### **デッキ全体の技情報の集約**

デッキコードから取得したカードリストに対して、各カードの詳細情報を取得し、デッキ全体の技構成を分析する例：

```javascript
const analyzeDeckWaza = async (deckCode) => {
  // 1. デッキコードからカードリストを取得
  const deckInfo = await getDeckInfo(deckCode);
  
  // 2. ポケモンカードのみを抽出
  const pokemonCards = deckInfo.cards.filter(card => card.category === 'ポケモン');
  
  // 3. 各カードの詳細情報を取得（並列処理）
  const cardDetails = await Promise.all(
    pokemonCards.map(async (card) => {
      try {
        const detail = await getCardDetails(card.cardId);
        return {
          ...card,
          waza: detail.waza,
          hp: detail.hp
        };
      } catch (error) {
        console.error(`カード ${card.cardId} の情報取得に失敗:`, error);
        return { ...card, waza: [], hp: null };
      }
    })
  );
  
  // 4. 技の統計情報を集計
  const wazaStats = {
    totalWaza: 0,
    energyTypes: {},
    damageRange: { min: Infinity, max: 0 },
    averageDamage: 0
  };
  
  cardDetails.forEach(card => {
    card.waza.forEach(waza => {
      wazaStats.totalWaza++;
      
      // エネルギータイプの集計
      waza.energyCost.forEach(type => {
        wazaStats.energyTypes[type] = (wazaStats.energyTypes[type] || 0) + 1;
      });
      
      // ダメージ範囲の更新
      if (waza.damage !== null) {
        wazaStats.damageRange.min = Math.min(wazaStats.damageRange.min, waza.damage);
        wazaStats.damageRange.max = Math.max(wazaStats.damageRange.max, waza.damage);
      }
    });
  });
  
  return {
    cards: cardDetails,
    statistics: wazaStats
  };
};
```

## **セキュリティと運用上の注意事項**

### **サーバー負荷への配慮**

公式サイトへの過度なアクセスは、サーバーに負荷をかける可能性がある。以下の点に注意する。

* **リクエスト間隔**: 連続リクエストの間に1秒以上の待機時間を設ける
* **並列処理の制限**: 同時に送信するリクエスト数を制限する（推奨: 3件以下）
* **キャッシュの活用**: 一度取得したカード情報は、カードIDとレギュレーションをキーとしてローカルに保存し、再取得を避ける
* **User-Agentの明示**: 適切なUser-Agentヘッダを設定し、どのツールからのアクセスかを明示する

### **データの正確性**

カード情報は、レギュレーションやセットによって異なる場合がある。同じカードIDでも、異なるレギュレーションでアクセスすると、異なる情報が返される可能性がある。デッキコードから取得したレギュレーション情報を正確に保持し、カード詳細ページへのアクセス時に使用する必要がある。

### **将来の変更への対応**

公式サイトのHTML構造が変更された場合、情報抽出のロジックが動作しなくなる可能性がある。定期的な動作確認と、エラーハンドリングの強化が推奨される。

## **まとめ**

ポケモンカード公式サイトのカード詳細ページから、技情報、エネルギーコスト、HP、弱点・抵抗力などの戦闘パラメータを自動的に取得することが可能である。Puppeteerなどのヘッドレスブラウザツールを使用し、適切な待機処理とエラーハンドリングを実装することで、安定した情報取得システムを構築できる。

取得した情報は、デッキ分析、戦闘シミュレーション、メタゲーム分析など、様々な用途に活用できる。ただし、公式サイトへの負荷を考慮し、適切なリクエスト間隔とキャッシュ戦略を実装することが重要である。

#### **参考実装**

本資料で説明した技術は、以下のプロジェクトで実装されている。

* デッキコード解析システム: `server.js` の `/api/deck` エンドポイント
* カード詳細情報取得: 本資料で説明した `extractWazaInfo`, `extractBasicInfo`, `extractWeaknessResistance` 関数

#### **今後の拡張可能性**

* **特性（特性）情報の取得**: 一部のポケモンカードには「特性」が記載されている。同様の手法で取得可能
* **進化ラインの自動追跡**: 進化情報セクションから、進化前後のポケモンを自動的にリンクし、進化ラインを可視化
* **バトルシミュレーターへの統合**: 取得した技情報とエネルギーコストを基に、自動的なバトルシミュレーション機能の実装
