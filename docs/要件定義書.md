# ポケモンカード検索システム 要件定義書

## 1. はじめに

### 1.1 目的

本ドキュメントは、ポケモンカードゲーム（ポケカ）のカードを検索・参照するためのシステム（以下「本システム」）の要件を定義する。既存ドキュメント（データベース定義、公式サイトからの情報取得仕様、デッキコード取得仕様など）を踏まえ、検索システムとして必要な機能と制約を整理する。

### 1.2 スコープ

- **対象**: 既に別ツールで収集・格納されたカードデータ（D1）の検索・参照・表示
- **対象外**: データ収集（別ツールで実施）、デッキコード連携（今後の拡張）、公式サイト以外のデータソース、デッキ構築・対戦シミュレーションの詳細ロジック、決済・会員機能

### 1.3 関連ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| [Cloudflare D1 テーブル定義書](./Cloudflare%20D1%20テーブル定義書.md) | カード・ワザ・特性等のDBスキーマ |
| [カード詳細ページからの情報取得](./カード詳細ページからの情報取得.md) | 詳細ページからのスクレイピング仕様 |
| [ポケカデッキコードからの情報取得](./ポケカデッキコードからの情報取得.md) | デッキコードと result.html の仕様 |
| [画像取得の仕組み](./画像取得の仕組み.md) | 画像URLの取得方法（PCGDECK） |
| [pokeca-deck-fetcher README/SPEC](./pokeca-deck-fetcher/) | デッキ情報取得ライブラリのAPI |

---

## 2. システム概要

### 2.1 システムの位置づけ

本システムの位置づけは**検索・参照のみ**とする。

- **検索・参照**: 既に格納されているカードデータ（Cloudflare D1）を検索し、ユーザーにカード一覧・詳細を提供する。
- **データ収集**: 本システムでは行わない。別ツールで収集されたデータを D1 に格納する運用を前提とする。
- **デッキコード連携**: 本システムのスコープ外とする。今後の拡張で検討する。

画像はカードデータに格納された公式サイトのURLを参照する方式（ホットリンク）を基本とし、ストレージには保存しない。

### 2.2 想定ユーザー

- **ポケカプレイヤー**（カード検索・デッキ構築の参考・カード詳細の確認）

---

## 3. 機能要件

### 3.1 カード検索

| ID | 要件 | 詳細 | 優先度 |
|----|------|------|--------|
| F-001 | カード名検索 | カード名（またはフルネーム）による部分一致・完全一致検索。D1 の `cards.name` / `full_name` およびインデックス `idx_cards_name` を利用する。 | 必須 |
| F-002 | カテゴリ絞り込み | ポケモン・グッズ・ポケモンのどうぐ・サポート・スタジアム・エネルギーのいずれかで絞り込み。`cards.category` および `idx_cards_category` を利用する。 | 必須 |
| F-003 | セット絞り込み | セットコード（例: M2a, SV7a）またはセット名で絞り込み。`cards.set_code` / `set_name` および `idx_cards_set_code` を利用する。 | 必須 |
| F-004 | レギュレーション絞り込み | レギュレーション（例: D〜, E〜）で絞り込み。`cards.regulation` および `idx_cards_regulation` を利用する。 | 必須 |
| F-005 | タイプ・進化段階絞り込み | カードタイプ（`card_type`）・進化段階（たね/1進化/2進化）で絞り込み。`idx_cards_card_type`, `idx_cards_evolution_stage` を利用する。 | 推奨 |
| F-006 | HP・にげるコスト範囲 | HP やにげるコスト（`retreat_cost`）の範囲指定。数値検索用のインデックスは必要に応じて追加する。 | 任意 |
| F-007 | **ワザの必要エネルギーで検索** | 指定したエネルギータイプ・必要数で使えるワザを持つカードを検索する。例：「草エネルギー1つで使えるワザを持つポケモン」「炎2・無色1で使えるワザがあるカード」。`waza` と `waza_energy_cost` を結合し、`energy_type`（grass / fire / water / lightning / psychic / fighting / dark / metal / colorless）および各タイプの必要数で絞り込む。同一ワザ内で同じ energy_type が複数ある場合はその枚数で判定する。 | 必須 |
| F-008 | 検索結果の表示項目 | 一覧では少なくとも「カード名・カテゴリ・セット・レギュレーション・画像URL」を返す。詳細では D1 の cards / waza / waza_energy_cost / abilities を結合して返す。 | 必須 |
| F-009 | ページネーション・ソート | 検索結果のオフセット・リミット、および並び順（名前・セット・カード番号等）の指定。 | 推奨 |

### 3.2 カード詳細表示

| ID | 要件 | 詳細 | 優先度 |
|----|------|------|--------|
| F-010 | カードIDによる詳細取得 | `card_id`（5桁）をキーに1件のカードの詳細を返す。ワザ・エネルギーコスト・特性を含む。 | 必須 |
| F-011 | 詳細項目の内容 | テーブル定義書に準拠：名前、HP、タイプ、弱点・抵抗力・にげる、ワザ（名前・ダメージ・効果・エネルギーコスト）、特性、セット情報、レアリティ、イラストレーター等。 | 必須 |
| F-012 | 画像・詳細URL | 表示用に `image_url` と `detail_url`（公式詳細ページ）を返す。画像は公式サイトURLをそのまま利用（画像取得の仕組みに準拠）。 | 必須 |

---

## 4. 非機能要件

### 4.1 パフォーマンス

| ID | 要件 | 詳細 |
|----|------|------|
| NF-001 | 検索応答時間 | 通常の検索（絞り込み・ページネーション含む）は 2 秒以内を目安とする。 |
| NF-002 | 詳細取得 | 1 件あたりのカード詳細取得は 1 秒以内を目安とする（DB のみ参照の場合）。 |

### 4.2 可用性・運用

| ID | 要件 | 詳細 |
|----|------|------|
| NF-003 | データベース | Cloudflare D1（SQLite 互換）を前提とする。スキーマはテーブル定義書および `database/schema-d1.sql` に準拠する。 |
| NF-004 | 画像表示 | 画像は公式サイトのURLを参照する。公式側の変更・障害時は画像が表示されない可能性があることを許容し、`onerror` 等でフォールバック表示を行う。 |

### 4.3 公式サイトへのアクセス（参考）

本システムは検索・参照のみのため、通常は D1 への参照のみで公式サイトへ直接リクエストしない。画像表示はブラウザからカードデータに格納された公式URLを参照するため、クライアント側で行う。将来、サーバー側で公式サイトにアクセスする機能を追加する場合は、以下を遵守する。

| ID | 要件 | 詳細 |
|----|------|------|
| NF-005 | リクエスト間隔 | 公式サイトへの連続リクエストでは 1 秒以上の間隔を設ける。 |
| NF-006 | 並列度の制限 | 同時リクエストは 3 件以下に制限する。 |
| NF-007 | キャッシュ | 同一対象の結果は可能な範囲でキャッシュし、再取得を減らす。 |
| NF-008 | User-Agent | アクセス元が分かるよう適切な User-Agent を設定する。 |

### 4.4 セキュリティ・保守

| ID | 要件 | 詳細 |
|----|------|------|
| NF-009 | 入力検証 | 検索パラメータ・カードID・デッキコードは形式チェックを行い、不正な値はエラーで返す。 |
| NF-010 | エラーメッセージ | 機密情報を含まないこと。スタックトレースはログに限定する。 |

---

## 5. データモデル（参照）

本システムで扱う主要なデータは、Cloudflare D1 テーブル定義書に従う。

- **cards**: カード基本情報（card_id, name, category, image_url, detail_url, hp, card_type, weakness/resistance/retreat, set_code/set_name, regulation, waza/abilities は別テーブル）
- **waza / waza_energy_cost**: ワザとそのエネルギーコスト
- **abilities**: 特性
- **card_id_mapping**: 同一カードの別規制等のマッピング
- **collection_logs**: 収集ログ
- **products**: 商品マスタ（収集時の参照）

検索システムの API は、これらのテーブルを結合した「検索用ビュー」に相当するレスポンスを返すことを想定する。

---

## 6. 外部インターフェース

### 6.1 データソース

本システムは**既に別ツールで収集・格納された D1 のデータ**を参照する。公式サイトへの直接アクセスは行わない。画像はカードデータに格納された `image_url`（公式サイトのURL）をブラウザで参照する（画像取得の仕組みに準拠）。

### 6.2 本システムが提供するAPI（想定）

- **検索**: `GET /api/cards?name=&category=&set_code=&regulation=&energy=&energy_count=&...&offset=&limit=&order=`
  - `energy`: ワザの必要エネルギー検索用。エネルギータイプ（例: grass, fire）を指定。
  - `energy_count`: 上記タイプの必要数（例: 1 = 「草1つで使えるワザ」）。複数タイプ指定は別途API仕様で定義。
- **詳細**: `GET /api/cards/:cardId`

レスポンス形式（JSON）は別途 API 仕様で定義する。

---

## 7. 制約・前提

### 7.1 データの鮮度

- カード情報は公式サイトから収集した時点のものである。公式の仕様変更（レギュレーション・カードテキスト等）は、再収集するまで反映されない。

### 7.2 たねポケモン・進化段階

- 進化段階（たね/1進化/2進化）は、検索・表示には D1 に格納された `evolution_stage` を利用する。データ収集は別ツールで行う。

### 7.3 画像の利用

- 画像は公式サイトのURLを参照するのみで、自前でのホスティング・再配信は行わない。利用規約・負荷に配慮する。

### 7.4 技術スタック

- バックエンド: Node.js を想定（既存の pokeca-deck-fetcher やスクレイピング実装との整合）。
- DB: Cloudflare D1（スキーマはテーブル定義書準拠）。
- フロントエンド: 未定義（検索UIは別途要件化可能）。

---

## 8. 今後の拡張（メモ）

- **デッキコード連携**
  - デッキコード（XXXXXX-XXXXXX-XXXXXX）からデッキ情報を取得（例: `pokeca-deck-fetcher` 利用）。
  - 取得したデッキの各カードを本システムのカードデータと突き合わせて表示。
  - 進化段階（たねかどうか）の補完が必要な場合は、別ツールで収集したデータまたはカード詳細取得で対応。
- 特性・進化ラインの検索条件の追加
- ワザ名・効果テキストによる全文検索
- 商品マスタ（`products`）参照・カードIDマッピング（`card_id_mapping`）の活用
- デッキコード登録履歴・お気に入り（要ユーザー識別）

---

## 9. 用語集

| 用語 | 説明 |
|------|------|
| カードID | 公式サイトでカードを一意に識別する5桁の文字列（例: 48717） |
| デッキコード | 公式で発行される16桁の英数字（XXXXXX-XXXXXX-XXXXXX） |
| レギュレーション | 使用可能なカード範囲を表す区分（例: D〜, E〜, XY, SM, S, SV） |
| エネルギータイプ | ワザの必要エネルギー（grass=草, fire=炎, water=水, lightning=雷, psychic=超, fighting=闘, dark=悪, metal=鋼, colorless=無色）。D1 の `waza_energy_cost.energy_type` に格納。 |
| PCGDECK | 公式デッキ表示ページに埋め込まれた JavaScript オブジェクト（カード名・画像パス等）。データ収集時のみ参照。 |
| D1 | Cloudflare D1（SQLite 互換のサーバーレスDB） |

---

**ドキュメント版**: 1.1  
**作成日**: 2025-02-12  
**更新日**: 2025-02-12（スコープを検索・参照のみに変更、想定ユーザーをポケカプレイヤーのみに限定、ワザの必要エネルギー検索を追加、デッキコード連携・データ収集を今後の拡張に移動）  
**参照**: docs 内のテーブル定義書・情報取得・画像取得・pokeca-deck-fetcher 仕様
