# ポケモンカード検索システム 仕様書

本ドキュメントは、[要件定義書](./要件定義書.md)および[技術スタック](./技術スタック.md)を踏まえ、ポケモンカード検索システム（以下「本システム」）の詳細仕様を定義する。

---

## 1. 文書概要

### 1.1 目的

本仕様書は、開発者が実装に着手する際の技術的指針となる詳細仕様を記述する。

### 1.2 スコープ

- **対象**: 検索・参照機能の API・フロントエンドの実装仕様
- **対象外**: データ収集ツール、デッキコード連携（今後の拡張）

### 1.3 関連ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| [要件定義書](./要件定義書.md) | 機能要件・非機能要件 |
| [技術スタック](./技術スタック.md) | 技術選定・アーキテクチャ |
| [Cloudflare D1 テーブル定義書](./Cloudflare%20D1%20テーブル定義書.md) | DBスキーマ |
| [カード詳細ページからの情報取得](./カード詳細ページからの情報取得.md) | データ収集仕様 |
| [画像取得の仕組み](./画像取得の仕組み.md) | 画像URLの取得方法 |

---

## 2. システムアーキテクチャ

### 2.1 全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│                        Cloudflare エコシステム                      │
├─────────────────────────────────────────────────────────────────┤
│  Cloudflare Pages (フロントエンド)                                  │
│  └── Astro + Tailwind CSS / shadcn/ui                             │
├─────────────────────────────────────────────────────────────────┤
│  Cloudflare Workers (API)                                         │
│  └── Hono + TypeScript + Zod（入力検証）                            │
├─────────────────────────────────────────────────────────────────┤
│  Cloudflare D1 (データベース)                                      │
│  └── cards, waza, waza_energy_cost, abilities 等                   │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 リクエストフロー

```
ブラウザ → Cloudflare Pages (Astro) → API (Workers) → D1
                      ↓
               fetch / SWR / TanStack Query
```

### 2.3 ディレクトリ構成

```
pokeca-search/
├── apps/
│   ├── web/                    # Cloudflare Pages（フロントエンド）
│   │   ├── src/
│   │   │   ├── components/
│   │   │   ├── layouts/
│   │   │   ├── pages/
│   │   │   └── lib/
│   │   └── astro.config.mjs
│   └── api/                    # Cloudflare Workers（API）
│       ├── src/
│       │   ├── index.ts
│       │   ├── routes/
│       │   │   ├── cards.ts
│       │   │   └── health.ts
│       │   ├── db/
│       │   │   └── queries.ts
│       │   └── schemas/
│       │       └── search.ts
│       └── wrangler.toml
├── database/
│   └── schema-d1.sql
└── package.json
```

---

## 3. API 仕様

### 3.1 基本方針

- **ベースURL**: `/api`（同一ドメイン配下）
- **レスポンス形式**: JSON
- **文字コード**: UTF-8
- **入力検証**: Zod または Valibot で全パラメータを検証（NF-009）

### 3.2 検索 API

#### `GET /api/cards`

カード検索を行う。

**クエリパラメータ**

| パラメータ | 型 | 必須 | 説明 |
|------------|-----|------|------|
| `name` | string | × | カード名（部分一致）。`name` または `full_name` を検索 |
| `exact` | boolean | × | 完全一致検索（デフォルト: false） |
| `category` | enum | × | カテゴリ。`ポケモン` / `グッズ` / `ポケモンのどうぐ` / `サポート` / `スタジアム` / `エネルギー` |
| `set_code` | string | × | セットコード（例: M2a, SV7a） |
| `set_name` | string | × | セット名（部分一致） |
| `regulation` | string | × | レギュレーション（例: D〜, E〜, SV） |
| `card_type` | string | × | カードタイプ（進化段階等） |
| `evolution_stage` | string | × | 進化段階。`たね` / `1進化` / `2進化` |
| `hp_min` | integer | × | HP 最小値 |
| `hp_max` | integer | × | HP 最大値 |
| `retreat_min` | integer | × | にげるコスト最小値 |
| `retreat_max` | integer | × | にげるコスト最大値 |
| `energy` | string | × | エネルギータイプ。`grass` / `fire` / `water` / `lightning` / `psychic` / `fighting` / `dark` / `metal` / `colorless` |
| `energy_count` | integer | × | 上記エネルギーの必要数（例: 1 = 「草1つで使えるワザ」）。`energy` とペアで指定 |
| `energy_extra` | string | × | 複数エネルギータイプ検索時、追加タイプ（例: `fire,1` = 炎1追加）。フォーマットは別途定義 |
| `offset` | integer | × | オフセット（デフォルト: 0） |
| `limit` | integer | × | 取得件数（デフォルト: 20、最大: 100） |
| `order` | string | × | ソート順。`name` / `set_code` / `card_number` / `hp`（デフォルト: `name`） |
| `order_dir` | string | × | 昇順/降順。`asc` / `desc`（デフォルト: `asc`） |

**エネルギータイプ値**

| 値 | 説明 |
|----|------|
| grass | 草 |
| fire | 炎 |
| water | 水 |
| lightning | 雷 |
| psychic | 超 |
| fighting | 闘 |
| dark | 悪 |
| metal | 鋼 |
| colorless | 無色 |

**レスポンス（200 OK）**

```json
{
  "data": [
    {
      "card_id": "48717",
      "name": "ピカチュウ",
      "full_name": "ピカチュウ",
      "category": "ポケモン",
      "set_code": "SV7a",
      "set_name": "スカーレット&バイオレット 拡張パック「ポケモン LEGEND」",
      "regulation": "F〜",
      "image_url": "https://www.pokemon-card.com/...",
      "detail_url": "https://www.pokemon-card.com/..."
    }
  ],
  "total": 1234,
  "offset": 0,
  "limit": 20
}
```

**エラー（400 Bad Request）**

不正なパラメータの場合、検証エラーの詳細を返す。

```json
{
  "error": "VALIDATION_ERROR",
  "message": "パラメータが不正です",
  "details": [
    { "field": "limit", "message": "1以上100以下で指定してください" }
  ]
}
```

### 3.3 カード詳細 API

#### `GET /api/cards/:cardId`

カードID（5桁）で1件の詳細を取得する。

**パスパラメータ**

| パラメータ | 型 | 説明 |
|------------|-----|------|
| `cardId` | string | 5桁のカードID（例: 48717） |

**バリデーション**

- `cardId` は 5 桁の数字文字列であること
- 不正な場合: 400 Bad Request

**レスポンス（200 OK）**

```json
{
  "data": {
    "card_id": "48717",
    "name": "ピカチュウ",
    "full_name": "ピカチュウ",
    "category": "ポケモン",
    "image_url": "https://...",
    "detail_url": "https://...",
    "hp": 70,
    "card_type": "lightning",
    "energy_subtype": null,
    "effect_text": null,
    "evolution_stage": "たね",
    "pokemon_number": "25",
    "weakness": "闘×2",
    "weakness_type": "fighting",
    "weakness_value": "×2",
    "resistance": null,
    "resistance_type": null,
    "resistance_value": null,
    "retreat_cost": 1,
    "set_code": "SV7a",
    "set_name": "スカーレット&バイオレット 拡張パック「ポケモン LEGEND」",
    "regulation": "F〜",
    "regulation_mark": "F",
    "card_number": "025",
    "rarity": "コモン",
    "illustrator": "不明",
    "waza": [
      {
        "id": 1,
        "name": "でんきショック",
        "damage": 20,
        "damage_modifier": null,
        "effect": "コインを1回投げ、オモテなら、相手のバトルポケモンをマヒにする。",
        "energy_cost": [
          { "energy_type": "lightning", "order_index": 0 },
          { "energy_type": "colorless", "order_index": 1 }
        ]
      }
    ],
    "abilities": [
      {
        "id": 1,
        "name": "ちくでん",
        "effect": "このポケモンがいる限り..."
      }
    ]
  }
}
```

**エラー（404 Not Found）**

```json
{
  "error": "NOT_FOUND",
  "message": "指定されたカードが見つかりません"
}
```

### 3.4 ヘルスチェック API

#### `GET /api/health`

API の稼働状況を確認する。

**レスポンス（200 OK）**

```json
{
  "status": "ok",
  "timestamp": "2025-02-12T12:00:00.000Z",
  "database": "connected"
}
```

---

## 4. データベース仕様

### 4.1 参照テーブル

本システムが参照する主要テーブルは [Cloudflare D1 テーブル定義書](./Cloudflare%20D1%20テーブル定義書.md) に準拠する。

| テーブル | 用途 |
|----------|------|
| cards | 基本カード情報、検索対象 |
| waza | ワザ |
| waza_energy_cost | ワザのエネルギーコスト | エネルギー検索 |
| abilities | 特性 |

### 4.2 検索クエリ方針

- **JOIN の活用**: 1 リクエストあたり最大 1,000 回の SQL 制限のため、サブクエリや JOIN で集約する
- **インデックス利用**: テーブル定義書のインデックス（idx_cards_* 等）を活用
- **ページネーション**: OFFSET / LIMIT で実装

### 4.3 エネルギー検索の SQL 方針

```sql
-- 例: 草エネルギー1つで使えるワザを持つカードを検索
SELECT DISTINCT c.card_id
FROM cards c
JOIN waza w ON w.card_id = c.card_id
JOIN waza_energy_cost wec ON wec.waza_id = w.id
WHERE wec.energy_type = 'grass'
GROUP BY c.card_id, w.id
HAVING SUM(CASE WHEN wec.energy_type = 'grass' THEN 1 ELSE 0 END) >= 1
```

複数エネルギータイプ検索時は、同様の条件を AND で結合する。

---

## 5. フロントエンド仕様

### 5.1 技術スタック

| 項目 | 技術 |
|------|------|
| フレームワーク | Astro |
| ホスティング | Cloudflare Pages |
| スタイリング | Tailwind CSS + shadcn/ui（任意） |
| データフェッチ | fetch + SWR / TanStack Query |

### 5.2  pages 構成

| パス | 説明 |
|------|------|
| `/` | 検索トップ。検索フォーム + 検索結果一覧 |
| `/cards/:cardId` | カード詳細ページ |

### 5.3 検索画面

- **検索フォーム**: カード名、カテゴリ、セット、レギュレーション、エネルギータイプ等の絞り込み
- **結果一覧**: カード名・カテゴリ・セット・レギュレーション・サムネイル画像
- **ページネーション**: offset / limit によるページ切り替え
- **ソート**: 名前・セット・カード番号等で切り替え

### 5.4 カード詳細画面

- **表示項目**: テーブル定義書に準拠。名前、HP、タイプ、弱点・抵抗力・にげる、ワザ（名前・ダメージ・効果・エネルギーコスト）、特性、セット情報、レアリティ、イラストレーター等
- **画像**: `image_url` を `img` で表示。`onerror` でフォールバック（NF-004）
- **詳細リンク**: `detail_url` を公式サイトへのリンクとして表示

### 5.5 部分 hydration

- 検索フォーム・結果一覧などインタラクティブな部分は Island として React / Vue 等でクライアント hydration
- 静的コンテンツはそのまま HTML で出力して軽量化

---

## 6. エラー処理

### 6.1 API エラーレスポンス

| HTTP ステータス | 内容 |
|-----------------|------|
| 400 | バリデーションエラー。詳細を `details` に含める |
| 404 | カードが見つからない |
| 500 | サーバー内部エラー。スタックトレースはログに限定し、レスポンスには機密情報を含まない（NF-010） |

### 6.2 フロントエンドエラー表示

- ネットワークエラー: リトライ可能な旨を表示
- 404: 「カードが見つかりません」
- 500: 汎用エラーメッセージ

---

## 7. セキュリティ

### 7.1 入力検証（NF-009）

- 全 API パラメータを Zod / Valibot で検証
- 不正な値は 400 で返却
- card_id: 5桁数字のみ許可
- limit: 1〜100 に制限
- offset: 0 以上
- enum 系: 許可リストで検証

### 7.2 エラーメッセージ（NF-010）

- 機密情報を含まない
- スタックトレースはサーバーログに限定

---

## 8. パフォーマンス要件

| ID | 要件 | 詳細 |
|----|------|------|
| NF-001 | 検索応答時間 | 2 秒以内を目安 |
| NF-002 | 詳細取得 | 1 秒以内を目安 |

**対策**

- インデックスを活用したクエリ設計
- ページネーションで結果件数を制限
- エッジ実行（Workers）による低レイテンシ

---

## 9. デプロイ・運用

### 9.1 ビルド・デプロイ

| ツール | 用途 |
|--------|------|
| Wrangler | Workers・D1 のデプロイ |
| Cloudflare Pages | フロントエンドのビルド・デプロイ |
| GitHub Actions | CI/CD（任意） |

### 9.2 環境変数

| 変数 | 用途 |
|------|------|
| D1 バインディング | Workers から D1 への接続 |

`wrangler.toml` で D1 データベースをバインディングする。

---

## 10. 今後の拡張（メモ）

- **デッキコード連携**: `pokeca-deck-fetcher` と連携。@cloudflare/puppeteer または別サービスでの実装を検討
- **特性・進化ライン検索**: 検索条件の追加
- **ワザ名・効果テキスト全文検索**: フルテキスト検索の導入
- **card_id_mapping / products 活用**: 商品マスタ・カードIDマッピングの参照

---

## 11. 用語集

| 用語 | 説明 |
|------|------|
| カードID | 公式サイトでカードを一意に識別する5桁の文字列 |
| エネルギータイプ | grass / fire / water / lightning / psychic / fighting / dark / metal / colorless |
| レギュレーション | 使用可能なカード範囲（例: D〜, E〜, SV） |
| D1 | Cloudflare D1（SQLite 互換のサーバーレスDB） |

---

**ドキュメント版**: 1.0  
**作成日**: 2025-02-12  
**参照**: 要件定義書、技術スタック、Cloudflare D1 テーブル定義書
