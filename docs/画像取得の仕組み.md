# 画像取得の仕組み

## 概要

本アプリケーションでは、カード画像を**公式サイトのJavaScriptオブジェクトから取得**しています。画像自体をダウンロードするのではなく、**画像のURLを取得**して、フロントエンドで直接表示しています。

## 取得フロー

```
1. デッキコードからデッキページにアクセス
   ↓
2. ページ内のJavaScriptオブジェクト（PCGDECK）を読み込む
   ↓
3. PCGDECK.searchItemCardPict[cardId] から画像パスを取得
   ↓
4. 相対パスを絶対URLに変換
   ↓
5. フロントエンドで<img>タグのsrc属性に設定
```

## 詳細な仕組み

### 1. 公式サイトのJavaScriptオブジェクト

公式サイトのデッキ表示ページ（`result.html`）には、以下のようなJavaScriptオブジェクトが埋め込まれています：

```javascript
PCGDECK.searchItemCardPict[48624] = '/assets/images/card_images/large/M2a/048624_P_ROKETTODANNOYAMIKARASU.jpg';
PCGDECK.searchItemName[48624] = 'ロケット団のヤミカラス(M2a 102/193)';
PCGDECK.searchItemNameAlt[48624] = 'ロケット団のヤミカラス';
```

### 2. サーバー側での取得（server.js）

```javascript:113:114:server.js
imageUrl: window.PCGDECK.searchItemCardPict && window.PCGDECK.searchItemCardPict[cardId] ? 
  `https://www.pokemon-card.com${window.PCGDECK.searchItemCardPict[cardId]}` : null,
```

このコードでは：
- `window.PCGDECK.searchItemCardPict[cardId]` から相対パスを取得
- 相対パス（例: `/assets/images/card_images/large/...`）を絶対URLに変換
- 完全なURL（例: `https://www.pokemon-card.com/assets/images/card_images/large/...`）として返す

### 3. フロントエンドでの表示（app.js）

```javascript
const imageHtml = card.imageUrl 
  ? `<img src="${card.imageUrl}" alt="${card.name}" class="card-image" onerror="this.style.display='none'">`
  : '<div class="card-image" style="display: flex; align-items: center; justify-content: center; color: #999;">画像なし</div>';
```

フロントエンドでは：
- 取得した画像URLを`<img>`タグの`src`属性に設定
- 画像の読み込みに失敗した場合は`onerror`で非表示にする

## 画像URLの構造

取得される画像URLの例：

```
https://www.pokemon-card.com/assets/images/card_images/large/M2a/048624_P_ROKETTODANNOYAMIKARASU.jpg
```

パスの構成：
- `/assets/images/card_images/large/` - ベースパス
- `M2a/` - セットコード（拡張パック名）
- `048624_P_ROKETTODANNOYAMIKARASU.jpg` - ファイル名
  - `048624` - カードID（5桁、先頭に0パディング）
  - `P` - カードタイプ（P=Pokemon, T=Trainer, E=Energy）
  - `ROKETTODANNOYAMIKARASU` - カード名のローマ字表記

## 重要なポイント

### ✅ 画像は直接ダウンロードしない

- 画像ファイル自体をサーバーに保存していない
- 公式サイトの画像URLをそのまま使用（**ホットリンク**）
- サーバーのストレージを消費しない

### ✅ CORS（Cross-Origin Resource Sharing）について

公式サイトの画像は、ブラウザから直接アクセス可能です：
- 画像ファイルは通常、CORS制限が緩い
- `<img>`タグでの表示は通常問題なく動作する
- ただし、公式サイトのポリシー変更により、将来的に制限される可能性がある

### ⚠️ 注意事項

1. **公式サイトへの負荷**
   - 画像は公式サイトから直接読み込まれるため、アクセス数が増えると公式サイトに負荷がかかります
   - 適切な利用を心がけてください

2. **画像の可用性**
   - 公式サイトのURL構造が変更されると、画像が表示されなくなる可能性があります
   - `onerror`ハンドラーで画像読み込み失敗時の処理を実装しています

3. **キャッシュ**
   - ブラウザが画像をキャッシュするため、2回目以降の表示は高速になります
   - サーバー側でのキャッシュは実装していません（必要に応じて追加可能）

## 代替案（将来の拡張）

もし公式サイトの画像が使えなくなった場合の対策：

1. **画像のプロキシ経由取得**
   - サーバー側で画像を取得してプロキシ経由で配信
   - CORS問題を回避できる

2. **画像のキャッシュ**
   - サーバー側で画像を一時的にキャッシュ
   - 公式サイトへの負荷を軽減

3. **CDNの利用**
   - 画像をCDNに保存して配信
   - ただし、著作権の問題があるため要確認

## まとめ

- **画像は公式サイトから直接取得**（URLのみ）
- **JavaScriptオブジェクト（PCGDECK）から画像パスを抽出**
- **フロントエンドで直接表示**（ホットリンク）
- **サーバーのストレージは使用しない**

この方式により、シンプルで効率的な実装を実現しています。
